# This workflow checks the statuses of cached dependencies used in this action
# with the help of the Licensed tool. If any licenses are invalid or missing,
# this workflow will fail. See: https://github.com/licensee/licensed

name: Licensed

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  licensed:
    name: Check Licenses
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f #v6.1.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Install Dependencies
        id: npm-ci
        run: npm ci

      - name: Setup Ruby
        id: setup-ruby
        uses: ruby/setup-ruby@d697be2f83c6234b20877c3b5eac7a7f342f0d0c #v1.269.0
        with:
          ruby-version: ruby

      - uses: licensee/setup-licensed@0d52e575b3258417672be0dff2f115d7db8771d8 #v1.3.2
        with:
          version: 4.x
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # If this is a workflow_dispatch event, update the cached licenses.
      - if: ${{ github.event_name == 'workflow_dispatch' }}
        name: Update Licenses
        id: update-licenses
        run: licensed cache

      # Then, create a new branch, commit the updated licenses, and create a PR.
      - if: ${{ github.event_name == 'workflow_dispatch' }}
        name: Create Branch and Commit Licenses
        id: commit-licenses
        run: |
          git config --local user.email "licensed-ci@users.noreply.github.com"
          git config --local user.name "licensed-ci"

          # Create and switch to new branch
          git checkout -b licensed/update

          git add .licenses/
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Auto-update license files"
            # Force push to update existing branch if PR already exists
            git push -f origin licensed/update
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - if: |
          ${{ github.event_name == 'workflow_dispatch' &&
          steps.commit-licenses.outputs.has_changes == 'true' }}
        name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Auto-update license files" \
            --body "Automated license cache update by Licensed tool." \
            --base main \
            --head licensed/update || echo "PR might already exist"

      # Last, check the status of the cached licenses.
      - name: Check Licenses
        id: check-licenses
        run: licensed status
